{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-0">Relat√≥rio Executivo de Qualidade</h4>
        <small class="text-muted">Vis√£o consolidada: {{ current_source }}</small>
    </div>
    <div class="btn-group">
        <a href="?source=Sales" class="btn btn-sm {% if current_source == 'Sales' %}btn-dark{% else %}btn-outline-dark{% endif %}">Sales</a>
        <a href="?source=P√≥s-Vendas" class="btn btn-sm {% if current_source == 'P√≥s-Vendas' %}btn-dark{% else %}btn-outline-dark{% endif %}">P√≥s-Vendas</a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <h6 class="text-uppercase op-7">NPS Index (Meta)</h6>
                <h1 class="display-4 fw-bold my-2">{{ nps_index }}</h1>
                <div class="progress bg-white bg-opacity-25" style="height: 4px;">
                    <div class="progress-bar bg-white" style="width: {{ nps_index }}%"></div>
                </div>
                <small class="mt-2 d-block">{{ stats_geral.total }} pesquisas totais</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-success">
            <div class="card-body">
                <h6 class="text-muted text-uppercase ls-1">Satisfa√ß√£o Geral</h6>
                <div class="d-flex align-items-center justify-content-between mt-3">
                    <h2 class="mb-0 fw-bold">{{ stats_geral.nps }}</h2>
                    <span class="badge bg-light text-dark">{{ stats_geral.p_pct }}% Promotores</span>
                </div>
                <small class="text-danger fw-bold mt-2 d-block">{{ stats_geral.d }} Detratores</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-info">
            <div class="card-body">
                <h6 class="text-muted text-uppercase ls-1">Consultor</h6>
                <div class="d-flex align-items-center justify-content-between mt-3">
                    <h2 class="mb-0 fw-bold">{{ stats_consultant.nps }}</h2>
                    <span class="badge bg-light text-dark">{{ stats_consultant.p_pct }}% Promotores</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-warning">
            <div class="card-body">
                <h6 class="text-muted text-uppercase ls-1">Entrega</h6>
                <div class="d-flex align-items-center justify-content-between mt-3">
                    <h2 class="mb-0 fw-bold">{{ stats_delivery.nps }}</h2>
                    <span class="badge bg-light text-dark">{{ stats_delivery.p_pct }}% Promotores</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">Evolu√ß√£o da Nota M√©dia (Geral)</h6>
            </div>
            <div class="card-body">
                <canvas id="chartTrend" height="100"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">Distribui√ß√£o de Notas</h6>
            </div>
            <div class="card-body">
                <canvas id="chartDist" height="220"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0 fw-bold">üèÜ Top 5 Melhores Lojas</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Loja</th>
                            <th class="text-center">M√©dia</th>
                            <th class="text-center">Qtd</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loja in top_lojas %}
                        <tr>
                            <td class="fw-bold">{{ loja.location_name }}</td>
                            <td class="text-center text-success fw-bold">{{ loja.media|floatformat:1 }}</td>
                            <td class="text-center">{{ loja.total }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center">Sem dados suficientes</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0 fw-bold">‚ö†Ô∏è Lojas em Aten√ß√£o (Bottom 5)</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Loja</th>
                            <th class="text-center">M√©dia</th>
                            <th class="text-center">Qtd</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for loja in bottom_lojas %}
                        <tr>
                            <td class="fw-bold">{{ loja.location_name }}</td>
                            <td class="text-center text-danger fw-bold">{{ loja.media|floatformat:1 }}</td>
                            <td class="text-center">{{ loja.total }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center">Sem dados suficientes</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Dados vindos do Django
    const dates = JSON.parse('{{ chart_dates|safe }}');
    const scores = JSON.parse('{{ chart_scores|safe }}');
    const distValues = JSON.parse('{{ chart_dist_values|safe }}');

    // 1. Gr√°fico de Linha (Tend√™ncia)
    new Chart(document.getElementById('chartTrend'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Nota M√©dia Geral',
                data: scores,
                borderColor: '#5D87FF',
                backgroundColor: 'rgba(93, 135, 255, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: false, min: 1, max: 5 }
            }
        }
    });

    // 2. Gr√°fico de Rosca (Distribui√ß√£o)
    new Chart(document.getElementById('chartDist'), {
        type: 'doughnut',
        data: {
            labels: ['1 Estrela', '2 Estrelas', '3 Estrelas', '4 Estrelas', '5 Estrelas'],
            datasets: [{
                data: distValues,
                backgroundColor: [
                    '#FA896B', // Vermelho (1)
                    '#FFAE1F', // Laranja (2)
                    '#FFAE1F', // Laranja (3)
                    '#5D87FF', // Azul (4)
                    '#13DEB9'  // Verde (5)
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>
{% endblock %}